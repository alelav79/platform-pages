<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISS Tracker - Stazione Spaziale Internazionale</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%);
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                filter: drop-shadow(0 0 5px rgba(102, 126, 234, 0.5));
            }
            to {
                filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.8));
            }
        }

        .subtitle {
            font-size: 1.1em;
            color: #a0aec0;
            margin-top: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .stat-label {
            font-size: 0.9em;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #fff;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .map-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }

        #map {
            height: 600px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .info-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #667eea;
        }

        .info-text {
            line-height: 1.8;
            color: #cbd5e0;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #48bb78;
            margin-right: 8px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        footer {
            text-align: center;
            padding: 30px;
            color: #718096;
            margin-top: 40px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #667eea;
        }

        /* Stile personalizzato per il popup della mappa */
        .leaflet-popup-content-wrapper {
            background: rgba(10, 14, 39, 0.95);
            color: #fff;
            border-radius: 10px;
            padding: 10px;
        }

        .leaflet-popup-content {
            margin: 10px;
        }

        .leaflet-popup-tip {
            background: rgba(10, 14, 39, 0.95);
        }

        /* Controlli mappa */
        .map-controls {
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-btn {
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(102, 126, 234, 0.5);
            color: #fff;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .control-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .control-btn.active {
            background: rgba(102, 126, 234, 0.5);
            border-color: #667eea;
        }

        .layer-selector {
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(102, 126, 234, 0.5);
            color: #fff;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.9em;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .layer-selector option {
            background: #0a0e27;
            color: #fff;
        }

        /* Sezione passaggi visibili */
        .passes-section {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .pass-item {
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .pass-time {
            font-size: 1.1em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .pass-details {
            font-size: 0.9em;
            color: #cbd5e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ∞Ô∏è ISS Live Tracker</h1>
            <p class="subtitle">
                <span class="status-indicator"></span>
                Tracciamento in tempo reale della Stazione Spaziale Internazionale
            </p>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Latitudine</div>
                <div class="stat-value" id="latitude">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Longitudine</div>
                <div class="stat-value" id="longitude">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Altitudine</div>
                <div class="stat-value" id="altitude">-- km</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Velocit√†</div>
                <div class="stat-value" id="velocity">-- km/h</div>
            </div>
            <div class="stat-card" style="grid-column: 1 / -1;">
                <div class="stat-label">üìç Posizione Attuale</div>
                <div class="stat-value" id="location" style="font-size: 1.3em;">
                    <span class="loading">Caricamento...</span>
                </div>
            </div>
        </div>

        <div class="passes-section">
            <h2 class="info-title">üî≠ Prossimi Passaggi ISS</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label class="stat-label" style="display: block; margin-bottom: 8px;">üìç Localit√†</label>
                    <input type="text" id="locationInput" placeholder="Es: Roma, Milano, Venezia..." 
                           value="Napoli, Italia"
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid rgba(102, 126, 234, 0.3); 
                                  background: rgba(255,255,255,0.05); color: #fff; font-size: 1em;">
                </div>
                
                <div>
                    <label class="stat-label" style="display: block; margin-bottom: 8px;">üìè Raggio di Ricerca</label>
                    <select id="radiusSelect" 
                            style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid rgba(102, 126, 234, 0.3); 
                                   background: rgba(255,255,255,0.05); color: #fff; font-size: 1em; cursor: pointer;">
                        <option value="100">100 km (vicinanza estrema)</option>
                        <option value="500">500 km (vicinanza alta)</option>
                        <option value="1000" selected>1000 km (regionale)</option>
                        <option value="2000">2000 km (nazionale)</option>
                        <option value="5000">5000 km (continentale)</option>
                    </select>
                </div>
            </div>
            
            <button onclick="searchPasses()" 
                    style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                           border: none; border-radius: 10px; color: white; font-size: 1.1em; font-weight: bold; 
                           cursor: pointer; transition: all 0.3s ease; margin-bottom: 20px;"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(102, 126, 234, 0.4)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                üîç Cerca Passaggi
            </button>
            
            <div id="search-info" style="margin-bottom: 15px; padding: 12px; background: rgba(102, 126, 234, 0.1); 
                                         border-radius: 8px; border-left: 3px solid #667eea; display: none;">
                <div style="color: #cbd5e0; font-size: 0.95em;" id="search-info-text"></div>
            </div>
            
            <div id="passes-container">
                <div class="loading">Inserisci una localit√† e un raggio, poi clicca "Cerca Passaggi"</div>
            </div>
        </div>

        <div class="map-container">
            <div class="map-controls">
                <button class="control-btn active" id="followBtn" onclick="toggleFollow()">
                    üìç Segui ISS
                </button>
                <select class="layer-selector" id="layerSelector" onchange="changeMapLayer()">
                    <option value="dark">üåô Scuro</option>
                    <option value="satellite">üõ∞Ô∏è Satellite</option>
                    <option value="street">üó∫Ô∏è Stradale</option>
                    <option value="terrain">üèîÔ∏è Terreno</option>
                </select>
            </div>
            <div id="map"></div>
        </div>

        <div class="info-panel">
            <h2 class="info-title">üì° Informazioni sulla ISS</h2>
            <p class="info-text">
                La Stazione Spaziale Internazionale (ISS) √® un laboratorio spaziale in orbita terrestre bassa, 
                situato a circa 400 km di altitudine. Viaggia a una velocit√† di circa 28.000 km/h e completa 
                un'orbita completa attorno alla Terra ogni 90 minuti circa. La ISS √® il risultato della 
                collaborazione tra cinque agenzie spaziali: NASA (Stati Uniti), Roscosmos (Russia), 
                JAXA (Giappone), ESA (Europa) e CSA (Canada).
            </p>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <h3 class="info-title" style="font-size: 1.1em; margin-bottom: 10px;">üõ§Ô∏è Traccia del Percorso</h3>
                <p class="info-text" style="font-size: 0.95em;">
                    La linea sulla mappa mostra il percorso orbitale degli ultimi ~25 minuti. 
                    I segmenti pi√π <span style="color: #4a5568; font-weight: bold;">scuri e sottili</span> rappresentano la posizione passata, 
                    mentre quelli pi√π <span style="color: #667eea; font-weight: bold;">luminosi e spessi</span> mostrano la posizione recente. 
                    Il punto blu brillante üîµ indica la posizione attuale della ISS.
                </p>
            </div>
        </div>

        <footer>
            <p>Dati forniti da Open Notify API | Aggiornamento ogni 5 secondi</p>
            <p style="margin-top: 10px; font-size: 0.9em;">Made with üíô by your friendly AI assistant</p>
        </footer>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Configurazione
        const YOUR_LOCATION = {
            lat: 40.8518,  // Napoli
            lon: 14.2681,
            name: 'Napoli, Italia'
        };

        let followMode = true;
        let currentLayer = null;
        let searchLocationMarker = null;
        let radiusCircle = null;
        
        // Funzione per calcolare la distanza tra due punti (formula di Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raggio della Terra in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Funzione per geocodificare un indirizzo
        async function geocodeLocation(locationName) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}&limit=1`,
                    {
                        headers: {
                            'User-Agent': 'ISS-Tracker-App'
                        }
                    }
                );
                const data = await response.json();
                
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon),
                        name: data[0].display_name
                    };
                }
                return null;
            } catch (error) {
                console.error('Errore nel geocoding:', error);
                return null;
            }
        }
        
        // Inizializzazione mappa
        const map = L.map('map').setView([YOUR_LOCATION.lat, YOUR_LOCATION.lon], 3);
        
        // Layer disponibili
        const mapLayers = {
            dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri',
                maxZoom: 19
            }),
            street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, SRTM | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>',
                maxZoom: 17
            })
        };

        // Aggiungi layer iniziale
        currentLayer = mapLayers.dark;
        currentLayer.addTo(map);

        // Aggiungi marker per la tua posizione
        const yourLocationMarker = L.marker([YOUR_LOCATION.lat, YOUR_LOCATION.lon], {
            icon: L.divIcon({
                className: 'your-location-icon',
                html: '<div style="font-size: 30px;">üìç</div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        }).addTo(map).bindPopup(`
            <div style="text-align: center;">
                <strong>La Tua Posizione</strong><br>
                ${YOUR_LOCATION.name}
            </div>
        `);

        // Funzione per cambiare layer
        function changeMapLayer() {
            const selectedLayer = document.getElementById('layerSelector').value;
            map.removeLayer(currentLayer);
            currentLayer = mapLayers[selectedLayer];
            currentLayer.addTo(map);
        }

        // Funzione per attivare/disattivare il follow mode
        function toggleFollow() {
            followMode = !followMode;
            const btn = document.getElementById('followBtn');
            if (followMode) {
                btn.classList.add('active');
                btn.textContent = 'üìç Segui ISS';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'üîì Libera';
            }
        }

        // Icona personalizzata per la ISS
        const issIcon = L.divIcon({
            className: 'iss-icon',
            html: `
                <div style="
                    font-size: 40px;
                    text-align: center;
                ">
                    üõ∞Ô∏è
                </div>
            `,
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });

        let issMarker = null;
        let issPath = [];
        let pathPolylines = []; // Array per contenere pi√π segmenti di percorso
        let lastLocation = '';

        // Funzione principale per cercare i passaggi
        async function searchPasses() {
            const locationInput = document.getElementById('locationInput').value;
            const radius = parseInt(document.getElementById('radiusSelect').value);
            const container = document.getElementById('passes-container');
            const searchInfo = document.getElementById('search-info');
            const searchInfoText = document.getElementById('search-info-text');
            
            // Mostra loading
            container.innerHTML = '<div class="loading">üîç Ricerca passaggi in corso...</div>';
            searchInfo.style.display = 'none';
            
            // Geocodifica la localit√†
            const location = await geocodeLocation(locationInput);
            
            if (!location) {
                container.innerHTML = '<p class="info-text" style="color: #f56565;">‚ö†Ô∏è Localit√† non trovata. Prova con un nome diverso (es: "Roma", "Milano", "Venezia")</p>';
                return;
            }
            
            // Mostra info sulla ricerca
            searchInfo.style.display = 'block';
            searchInfoText.innerHTML = `
                üìç Localit√†: <strong>${location.name.split(',')[0]}</strong><br>
                üìè Raggio: <strong>${radius} km</strong><br>
                üîÑ Monitoraggio in tempo reale attivo...
            `;
            
            // Rimuovi vecchi marker e cerchi se esistono
            if (searchLocationMarker) map.removeLayer(searchLocationMarker);
            if (radiusCircle) map.removeLayer(radiusCircle);
            
            // Aggiungi marker per la localit√† cercata
            searchLocationMarker = L.marker([location.lat, location.lon], {
                icon: L.divIcon({
                    className: 'search-location-icon',
                    html: '<div style="font-size: 35px;">üéØ</div>',
                    iconSize: [35, 35],
                    iconAnchor: [17.5, 17.5]
                })
            }).addTo(map).bindPopup(`
                <div style="text-align: center;">
                    <strong style="font-size: 1.1em;">üéØ Localit√† di Ricerca</strong><br>
                    <span style="font-size: 0.9em;">${location.name}</span><br>
                    <span style="font-size: 0.9em;">Raggio: ${radius} km</span>
                </div>
            `);
            
            // Aggiungi cerchio per visualizzare il raggio
            radiusCircle = L.circle([location.lat, location.lon], {
                radius: radius * 1000, // converti in metri
                color: '#667eea',
                fillColor: '#667eea',
                fillOpacity: 0.1,
                weight: 2,
                dashArray: '5, 10'
            }).addTo(map);
            
            // Centra sulla localit√† cercata
            map.fitBounds(radiusCircle.getBounds(), { padding: [50, 50] });
            
            // Monitora la posizione della ISS in tempo reale
            monitorISSPasses(location, radius);
        }
        
        // Funzione per monitorare i passaggi della ISS
        let passesData = [];
        let monitoringInterval = null;
        
        async function monitorISSPasses(location, radius) {
            const container = document.getElementById('passes-container');
            
            // Funzione per controllare la posizione attuale
            async function checkCurrentPosition() {
                try {
                    const response = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
                    const issData = await response.json();
                    
                    // Calcola la distanza attuale
                    const distance = calculateDistance(
                        location.lat, location.lon,
                        issData.latitude, issData.longitude
                    );
                    
                    const now = Date.now();
                    
                    // Verifica se la ISS √® entro il raggio
                    if (distance <= radius) {
                        const existingPass = passesData.find(p => 
                            Math.abs(p.startTime - now) < 300000 // stesso passaggio se entro 5 minuti
                        );
                        
                        if (!existingPass) {
                            passesData.unshift({
                                startTime: now,
                                distance: distance,
                                altitude: issData.altitude,
                                velocity: issData.velocity,
                                inProgress: true
                            });
                        } else {
                            existingPass.lastUpdate = now;
                            existingPass.distance = distance;
                        }
                    } else {
                        // Marca passaggi completati
                        passesData.forEach(pass => {
                            if (pass.inProgress && (now - pass.lastUpdate > 300000)) {
                                pass.inProgress = false;
                                pass.endTime = pass.lastUpdate;
                            }
                        });
                    }
                    
                    // Aggiorna la visualizzazione
                    updatePassesDisplay(location, radius, distance, issData);
                    
                } catch (error) {
                    console.error('Errore nel monitoraggio:', error);
                }
            }
            
            // Controlla subito
            checkCurrentPosition();
            
            // Ferma monitoraggio precedente se esiste
            if (monitoringInterval) clearInterval(monitoringInterval);
            
            // Controlla ogni 5 secondi
            monitoringInterval = setInterval(checkCurrentPosition, 5000);
        }
        
        // Funzione per aggiornare la visualizzazione dei passaggi
        function updatePassesDisplay(location, radius, currentDistance, issData) {
            const container = document.getElementById('passes-container');
            
            let html = '';
            
            // Mostra stato attuale
            const isWithinRadius = currentDistance <= radius;
            html += `
                <div class="pass-item" style="border-left-color: ${isWithinRadius ? '#48bb78' : '#f56565'}; background: ${isWithinRadius ? 'rgba(72, 187, 120, 0.1)' : 'rgba(245, 101, 101, 0.05)'};">
                    <div class="pass-time" style="color: ${isWithinRadius ? '#48bb78' : '#f56565'};">
                        ${isWithinRadius ? 'üü¢ ISS NEL RAGGIO!' : 'üî¥ ISS Fuori dal Raggio'}
                    </div>
                    <div class="pass-details">
                        üìè Distanza attuale: <strong>${currentDistance.toFixed(0)} km</strong><br>
                        üõ∞Ô∏è Altitudine: ${issData.altitude.toFixed(0)} km<br>
                        ‚ö° Velocit√†: ${issData.velocity.toFixed(0)} km/h<br>
                        ${isWithinRadius ? '‚ú® <strong>La ISS √® visibile dalla tua localit√†!</strong>' : `‚è≥ Attesa prossimo passaggio entro ${radius} km...`}
                    </div>
                </div>
            `;
            
            // Mostra storico passaggi
            if (passesData.length > 0) {
                html += '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);"><strong style="color: #667eea;">üìú Storico Passaggi:</strong></div>';
                
                passesData.slice(0, 10).forEach((pass, index) => {
                    const passDate = new Date(pass.startTime);
                    const dateStr = passDate.toLocaleDateString('it-IT', { 
                        day: 'numeric', 
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const duration = pass.endTime ? 
                        Math.round((pass.endTime - pass.startTime) / 60000) : 
                        'In corso';
                    
                    html += `
                        <div class="pass-item" style="opacity: ${1 - (index * 0.1)};">
                            <div class="pass-time">
                                ${pass.inProgress ? '‚ö° ' : '‚úÖ '}${dateStr}
                            </div>
                            <div class="pass-details">
                                üìè Distanza minima: ${pass.distance.toFixed(0)} km<br>
                                ‚è±Ô∏è Durata: ${duration === 'In corso' ? duration : duration + ' min'}<br>
                                ${pass.inProgress ? 'üîµ <strong>Passaggio in corso!</strong>' : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        // Funzione per ottenere il nome del luogo dalla posizione
        async function getLocationName(lat, lon) {
            try {
                // Usa Nominatim (OpenStreetMap) per reverse geocoding
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=3&addressdetails=1`,
                    {
                        headers: {
                            'User-Agent': 'ISS-Tracker-App'
                        }
                    }
                );
                const data = await response.json();
                
                if (data.address) {
                    // Priorit√†: paese > continente > oceano
                    const country = data.address.country;
                    const ocean = data.address.body_of_water;
                    
                    if (country) {
                        return `üåç ${country}`;
                    } else if (ocean) {
                        return `üåä ${ocean}`;
                    } else {
                        return 'üåä Oceano';
                    }
                } else {
                    return 'üåä Oceano';
                }
            } catch (error) {
                console.error('Errore nel reverse geocoding:', error);
                return 'Caricamento...';
            }
        }

        // Funzione per aggiornare i dati della ISS
        async function updateISSPosition() {
            try {
                const response = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
                const data = await response.json();

                const lat = parseFloat(data.latitude).toFixed(4);
                const lon = parseFloat(data.longitude).toFixed(4);
                const alt = parseFloat(data.altitude).toFixed(2);
                const vel = parseFloat(data.velocity).toFixed(2);

                // Aggiorna le statistiche
                document.getElementById('latitude').textContent = lat + '¬∞';
                document.getElementById('longitude').textContent = lon + '¬∞';
                document.getElementById('altitude').textContent = alt + ' km';
                document.getElementById('velocity').textContent = vel + ' km/h';

                // Aggiorna la posizione geografica (ogni 10 secondi per non sovraccaricare l'API)
                if (!lastLocation || issPath.length % 2 === 0) {
                    const location = await getLocationName(data.latitude, data.longitude);
                    lastLocation = location;
                    document.getElementById('location').textContent = location;
                }

                // Aggiorna marker sulla mappa
                if (issMarker) {
                    issMarker.setLatLng([data.latitude, data.longitude]);
                    issMarker.getPopup().setContent(`
                        <div style="text-align: center;">
                            <strong style="font-size: 1.2em;">üõ∞Ô∏è ISS</strong><br>
                            <span style="font-size: 0.9em;">${lastLocation}</span><br><br>
                            <span style="font-size: 0.9em;">Lat: ${lat}¬∞</span><br>
                            <span style="font-size: 0.9em;">Lon: ${lon}¬∞</span><br>
                            <span style="font-size: 0.9em;">Alt: ${alt} km</span><br>
                            <span style="font-size: 0.9em;">Vel: ${vel} km/h</span>
                        </div>
                    `);
                } else {
                    const location = await getLocationName(data.latitude, data.longitude);
                    lastLocation = location;
                    document.getElementById('location').textContent = location;
                    
                    issMarker = L.marker([data.latitude, data.longitude], {icon: issIcon})
                        .addTo(map)
                        .bindPopup(`
                            <div style="text-align: center;">
                                <strong style="font-size: 1.2em;">üõ∞Ô∏è ISS</strong><br>
                                <span style="font-size: 0.9em;">${location}</span><br><br>
                                <span style="font-size: 0.9em;">Lat: ${lat}¬∞</span><br>
                                <span style="font-size: 0.9em;">Lon: ${lon}¬∞</span><br>
                                <span style="font-size: 0.9em;">Alt: ${alt} km</span><br>
                                <span style="font-size: 0.9em;">Vel: ${vel} km/h</span>
                            </div>
                        `);
                    
                    // Centra sulla ISS solo la prima volta
                    if (followMode) {
                        map.setView([data.latitude, data.longitude], 4);
                    }
                }

                // Segui la ISS se il follow mode √® attivo
                if (followMode && issPath.length > 1) {
                    map.panTo([data.latitude, data.longitude], {
                        animate: true,
                        duration: 0.5
                    });
                }

                // Aggiungi punto al percorso
                issPath.push([data.latitude, data.longitude]);
                if (issPath.length > 300) {
                    issPath.shift(); // Mantieni solo gli ultimi 300 punti (circa 25 minuti di tracciamento)
                }

                // Rimuovi i vecchi segmenti di percorso
                pathPolylines.forEach(polyline => map.removeLayer(polyline));
                pathPolylines = [];

                // Crea segmenti di percorso con gradiente di colore e opacit√†
                // Dal pi√π vecchio (pi√π trasparente/grigio) al pi√π recente (pi√π opaco/blu)
                if (issPath.length > 1) {
                    const segmentSize = 20; // Numero di punti per segmento
                    const numSegments = Math.ceil(issPath.length / segmentSize);
                    
                    for (let i = 0; i < numSegments; i++) {
                        const startIdx = i * segmentSize;
                        const endIdx = Math.min(startIdx + segmentSize + 1, issPath.length);
                        const segmentPath = issPath.slice(startIdx, endIdx);
                        
                        if (segmentPath.length > 1) {
                            // Calcola l'intensit√† del colore basata sulla posizione nel percorso
                            const progress = i / numSegments; // 0 = vecchio, 1 = recente
                            
                            // Gradiente da grigio scuro a blu brillante
                            const opacity = 0.3 + (progress * 0.6); // Da 0.3 a 0.9
                            const hue = 240; // Blu
                            const saturation = 40 + (progress * 50); // Da 40% a 90%
                            const lightness = 40 + (progress * 20); // Da 40% a 60%
                            
                            const color = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                            const weight = 2 + (progress * 2); // Da 2 a 4 pixel
                            
                            const polyline = L.polyline(segmentPath, {
                                color: color,
                                weight: weight,
                                opacity: opacity,
                                smoothFactor: 1
                            }).addTo(map);
                            
                            pathPolylines.push(polyline);
                        }
                    }
                    
                    // Aggiungi un punto luminoso sulla posizione pi√π recente
                    const currentPos = issPath[issPath.length - 1];
                    const recentMarker = L.circleMarker(currentPos, {
                        radius: 8,
                        fillColor: '#667eea',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    pathPolylines.push(recentMarker);
                }

                // Aggiungi un cerchio per mostrare la direzione del movimento
                if (issPath.length > 1) {
                    const lastPoint = issPath[issPath.length - 1];
                    const secondLastPoint = issPath[issPath.length - 2];
                    
                    // Calcola l'angolo di movimento
                    const angle = Math.atan2(
                        lastPoint[0] - secondLastPoint[0],
                        lastPoint[1] - secondLastPoint[1]
                    ) * 180 / Math.PI;
                    
                    // Aggiorna l'icona con la direzione
                    const rotatedIcon = L.divIcon({
                        className: 'iss-icon',
                        html: `
                            <div style="
                                font-size: 40px;
                                text-align: center;
                                transform: rotate(${angle}deg);
                                transition: transform 0.5s ease;
                            ">
                                üõ∞Ô∏è
                            </div>
                        `,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    });
                    issMarker.setIcon(rotatedIcon);
                }

            } catch (error) {
                console.error('Errore nel recupero dei dati ISS:', error);
                document.getElementById('location').textContent = 'Errore di connessione';
            }
        }

        // Aggiorna immediatamente e poi ogni 5 secondi
        updateISSPosition();
        setInterval(updateISSPosition, 5000);

        // Aggiorna l'ora del browser ogni secondo
        setInterval(() => {
            const now = new Date();
            const timeString = now.toLocaleTimeString('it-IT');
            document.querySelector('.subtitle').innerHTML = `
                <span class="status-indicator"></span>
                Tracciamento in tempo reale della Stazione Spaziale Internazionale | ${timeString}
            `;
        }, 1000);
    </script>
</body>
</html>

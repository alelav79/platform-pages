<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore di Passo Avanzato v2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f0f2f5 0%, #e9ecef 100%);
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            font-size: 2.2rem;
            margin-top: 0;
            padding: 20px 0;
            border-bottom: 3px solid var(--accent-color);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 20px;
            transition: var(--transition);
        }
        
        .container:hover {
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 0.95rem;
        }
        
        input, select, button {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
            font-family: inherit;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="datetime-local"],
        select {
            width: 100%;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.2);
        }
        
        button {
            cursor: pointer;
            font-weight: 600;
            border: none;
            transition: var(--transition);
            height: 45px;
            display: inline-block;
            width: auto;
            padding: 10px 20px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            width: 100%;
            height: 45px;
            margin-top: 10px;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-secondary {
            background-color: var(--accent-color);
            color: white;
            margin-right: 10px;
        }
        
        .btn-secondary:hover {
            background-color: #3a7fbf;
        }
        
        .btn-copy {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-copy:hover {
            background-color: #388e3c;
        }
        
        .btn-reset {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-reset:hover {
            background-color: #d32f2f;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        #result {
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, var(--light-color), #fff);
            border-radius: var(--border-radius);
            color: var(--primary-color);
            border-left: 4px solid var(--accent-color);
            display: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .stat-box {
            background: linear-gradient(135deg, var(--light-color), #fff);
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--accent-color);
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 25px 0;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
        }
        
        .chart-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .chart-controls select {
            width: auto;
            flex: 1;
            min-width: 150px;
        }
        
        .inclination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--light-color), #fff);
            padding: 15px;
            border-radius: var(--border-radius);
        }
        
        .inclination-controls button {
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 18px;
            font-weight: bold;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
        }
        
        .inclination-controls button:hover {
            background-color: var(--primary-color);
        }
        
        .inclination-controls input[type="number"] {
            width: 70px;
            text-align: center;
        }
        
        #inclinationValue {
            font-weight: 600;
            color: var(--accent-color);
            width: 60px;
            text-align: center;
        }
        
        #inclinationSlider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #f44336, #ff9800, #4caf50);
            outline: none;
            margin: 15px 0;
        }
        
        #inclinationSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 3px solid var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        #inclinationSlider::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 3px solid var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        #paceList {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            display: none;
        }
        
        #paceList.active {
            display: block;
        }
        
        #paceList h3 {
            margin-top: 0;
            color: var(--secondary-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }
        
        #paceList ul {
            list-style-type: none;
            padding: 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        
        #paceList li {
            padding: 12px;
            background: linear-gradient(135deg, var(--light-color), #fff);
            border-radius: var(--border-radius);
            font-weight: 500;
            border-left: 3px solid var(--accent-color);
            transition: var(--transition);
            cursor: pointer;
        }
        
        #paceList li:hover {
            background: linear-gradient(135deg, #e9ecef, var(--light-color));
            transform: translateY(-2px);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }
        
        .modal.active {
            display: block;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .close:hover {
            color: var(--danger-color);
        }
        
        textarea {
            width: 100%;
            height: 250px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }
        
        .info-box {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            font-size: 0.95rem;
        }
        
        .info-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: #2196F3;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .hidden {
            display: none;
        }
        
        .loader {
            border: 4px solid var(--light-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            display: none;
            z-index: 1000;
        }

        .tooltip.active {
            display: block;
        }

        .chart-legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-box {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        #chart {
            cursor: crosshair;
            transition: filter 0.2s ease;
        }

        #chart.dragging {
            filter: brightness(1.05);
        }

        #paceList li {
            user-select: none;
            -webkit-user-select: none;
        }

        #paceList li[draggable="true"] {
            cursor: grab;
        }

        #paceList li[draggable="true"]:active {
            cursor: grabbing;
        }

        .edit-km-modal {
            position: absolute;
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            min-width: 200px;
        }

        .edit-km-modal input {
            width: 100%;
            margin-bottom: 10px;
        }

        .edit-km-modal button {
            width: 100%;
            margin-bottom: 5px;
        }

        .edit-km-modal button:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <h1>🏃 Calcolatore di Passo Avanzato v2</h1>
    
    <div class="main-grid">
        <!-- SEZIONE SINISTRA: INPUT -->
        <div class="container">
            <h2>Parametri Allenamento</h2>
            
            <div class="form-group">
                <label for="workoutName">Nome Allenamento</label>
                <input type="text" id="workoutName" placeholder="Es: Sessione velocità" value="Allenamento">
            </div>
            
            <div class="form-group">
                <label for="workoutDateTime">Data e Ora</label>
                <input type="datetime-local" id="workoutDateTime">
            </div>
            
            <div class="form-group">
                <label for="distance">Distanza (km)</label>
                <input type="number" id="distance" placeholder="10" value="10" min="0.1" step="0.1">
            </div>
            
            <div class="form-group">
                <label for="time">Tempo Totale (minuti)</label>
                <input type="number" id="time" placeholder="60" value="60" min="1" step="1">
            </div>
            
            <button class="btn-primary" onclick="calculatePace()">📊 Calcola Passo</button>
            
            <div id="result"></div>
            
            <!-- Stats Box -->
            <div id="statsBox" class="stats-grid hidden">
                <div class="stat-box">
                    <div class="stat-label">Velocità Media</div>
                    <div class="stat-value" id="avgSpeed">0 km/h</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Ritmo Min/Max</div>
                    <div class="stat-value" id="paceRange">0:00</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Pendenza</div>
                    <div class="stat-value" id="inclinationDisplay">0%</div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn-copy" id="copyButton" onclick="openCopyDialog()" style="display: none; flex: 1;">📋 Copia Risultati</button>
                <button class="btn-reset" onclick="resetForm()" style="flex: 1;">🔄 Ripristina</button>
            </div>
        </div>
        
        <!-- SEZIONE DESTRA: CONTROLLI GRAFICO -->
        <div class="container">
            <h2>Controlli Grafico</h2>
            
            <div class="info-box">
                <span class="info-icon">ℹ</span>
                <strong>Interazioni:</strong> 🖱️ <strong>Clicca + Trascina</strong> per modificare • 🔧 <strong>Doppio-click</strong> per editare • 📋 <strong>Trascinabile lista</strong>
            </div>
            
            <div class="form-group">
                <label for="chartType">Tipo di Grafico</label>
                <select id="chartType" onchange="updateChart()">
                    <option value="line">📈 Linea</option>
                    <option value="bar">📊 Barre</option>
                    <option value="radar">🎯 Radar</option>
                    <option value="area">🌊 Area</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="chartColor">Colore Grafico</label>
                <select id="chartColor" onchange="updateChart()">
                    <option value="#4361ee">🔵 Blu</option>
                    <option value="#f44336">🔴 Rosso</option>
                    <option value="#4caf50">🟢 Verde</option>
                    <option value="#ff9800">🟠 Arancione</option>
                    <option value="#9c27b0">🟣 Viola</option>
                    <option value="#00bcd4">🔷 Ciano</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Inclinazione</label>
                <div class="inclination-controls">
                    <button onclick="adjustInclination(-1)">−</button>
                    <input type="number" id="inclinationInput" value="0" min="-10" max="10" onchange="updateInclinationFromInput()">
                    <span>%</span>
                    <span id="inclinationValue">0%</span>
                    <button onclick="adjustInclination(1)">+</button>
                </div>
                <input type="range" id="inclinationSlider" min="-10" max="10" value="0" onchange="updateInclination()">
            </div>
            
            <div class="form-group">
                <label for="smoothness">Levigatezza Curva</label>
                <select id="smoothness" onchange="updateChart()">
                    <option value="0">Lineare</option>
                    <option value="0.2" selected>Normale</option>
                    <option value="0.4">Morbida</option>
                    <option value="0.6">Molto Morbida</option>
                </select>
            </div>
            
            <button class="btn-secondary" onclick="exportAsImage()" style="width: 100%; margin-top: 20px;">📥 Scarica Grafico</button>
        </div>
    </div>
    
    <!-- SEZIONE GRAFICO -->
    <div class="container">
        <div class="chart-container">
            <canvas id="chart"></canvas>
            <div class="tooltip" id="tooltip"></div>
        </div>
        <div class="chart-legend" id="chartLegend"></div>
    </div>
    
    <!-- LISTA DETTAGLIATA PASSO -->
    <div id="paceList"></div>
    
    <!-- MODAL COPIA -->
    <div id="copyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCopyDialog()">&times;</span>
            <h2>Risultati Allenamento</h2>
            <textarea id="copyText" readonly></textarea>
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn-copy" onclick="copyToClipboard()" style="flex: 1;">📋 Copia negli Appunti</button>
                <button class="btn-secondary" onclick="closeCopyDialog()" style="flex: 1;">❌ Chiudi</button>
            </div>
        </div>
    </div>

    <!-- MODAL EDIT KM -->
    <div id="editKmModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditKmModal()">&times;</span>
            <h2>Modifica Passo - <span id="editKmLabel">Km</span></h2>
            
            <div class="info-box" style="margin-bottom: 20px;">
                <span class="info-icon">ℹ</span>
                Inserisci il passo desiderato in minuti e secondi
            </div>
            
            <div class="form-group">
                <label>Passo (min:sec)</label>
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: end;">
                    <div>
                        <label for="editKmMinutes" style="font-size: 0.9rem; margin-bottom: 5px;">Minuti</label>
                        <input type="number" id="editKmMinutes" min="0" max="59" value="0">
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color); text-align: center;">:</div>
                    <div>
                        <label for="editKmSeconds" style="font-size: 0.9rem; margin-bottom: 5px;">Secondi</label>
                        <input type="number" id="editKmSeconds" min="0" max="59" value="0">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label style="color: #666; font-size: 0.9rem; font-weight: 400;">Passo attuale: <span id="currentPaceDisplay" style="color: var(--primary-color); font-weight: 600;">0:00</span></label>
            </div>
            
            <div class="btn-group" style="margin-top: 25px;">
                <button class="btn-primary" onclick="saveEditKmModal()" style="flex: 1; background-color: var(--success-color);">✅ Salva</button>
                <button class="btn-reset" onclick="closeEditKmModal()" style="flex: 1;">❌ Annulla</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== GESTIONE STATO ====================
        const AppState = {
            distance: 10,
            time: 60,
            averagePace: 0,
            chart: null,
            currentPaces: [],
            selectedKm: null,
            
            init() {
                this.setDefaultDateTime();
            },
            
            setDefaultDateTime() {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('workoutDateTime').value = now.toISOString().slice(0, 16);
            }
        };

        // ==================== CALCOLI ====================
        const PaceCalculator = {
            calculateAveragePace(distance, time) {
                return time / distance;
            },
            
            calculatePaces(inclinationPercent, totalKm, averagePace, time) {
                const paces = [];
                const inclinationFactor = 1 + (inclinationPercent / 100);
                
                for (let i = 0; i < totalKm; i++) {
                    const factor = Math.pow(inclinationFactor, i - (totalKm - 1) / 2);
                    paces.push(averagePace * factor);
                }
                
                const totalCalculatedTime = paces.reduce((sum, pace) => sum + pace, 0);
                const normalizationFactor = time / totalCalculatedTime;
                return paces.map(pace => pace * normalizationFactor);
            },
            
            formatPace(pace) {
                const minutes = Math.floor(pace);
                const seconds = Math.round((pace - minutes) * 60);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            },
            
            getStats(paces, distance, time) {
                const minPace = Math.min(...paces);
                const maxPace = Math.max(...paces);
                const avgSpeed = (distance / time * 60).toFixed(2);
                
                return {
                    avgSpeed: avgSpeed,
                    minPace: this.formatPace(minPace),
                    maxPace: this.formatPace(maxPace),
                    paceRange: `${this.formatPace(minPace)} - ${this.formatPace(maxPace)}`
                };
            }
        };

        // ==================== UI UPDATES ====================
        const UIManager = {
            showResult(text) {
                const resultElement = document.getElementById('result');
                resultElement.innerHTML = `✅ ${text}`;
                resultElement.style.display = 'block';
            },
            
            updateStats(stats, inclination) {
                const statsBox = document.getElementById('statsBox');
                document.getElementById('avgSpeed').textContent = `${stats.avgSpeed} km/h`;
                document.getElementById('paceRange').textContent = stats.paceRange;
                document.getElementById('inclinationDisplay').textContent = `${inclination}%`;
                statsBox.classList.remove('hidden');
            },
            
            updatePaceList(paces) {
                const paceList = document.getElementById('paceList');
                let html = '<h3>🏃 Passo per Chilometro:</h3><ul>';
                
                paces.forEach((pace, index) => {
                    const formattedPace = PaceCalculator.formatPace(pace);
                    html += `<li onclick="highlightKm(${index})" data-km="${index}">Km ${index + 1}: ${formattedPace}</li>`;
                });
                
                html += '</ul>';
                paceList.innerHTML = html;
                paceList.classList.add('active');
            }
        };

        // ==================== VALIDAZIONE ====================
        function validateInput() {
            const distance = parseFloat(document.getElementById('distance').value);
            const time = parseInt(document.getElementById('time').value);
            
            if (isNaN(distance) || isNaN(time) || distance <= 0 || time <= 0) {
                alert('❌ Inserisci valori validi per distanza e tempo.');
                return false;
            }
            return true;
        }

        // ==================== CALCOLO PRINCIPALE ====================
        function calculatePace() {
            if (!validateInput()) return;
            
            AppState.distance = parseFloat(document.getElementById('distance').value);
            AppState.time = parseInt(document.getElementById('time').value);
            AppState.averagePace = PaceCalculator.calculateAveragePace(AppState.distance, AppState.time);
            
            const paceMinutes = Math.floor(AppState.averagePace);
            const paceSeconds = Math.round((AppState.averagePace - paceMinutes) * 60);
            
            UIManager.showResult(`Passo medio: ${paceMinutes}:${paceSeconds.toString().padStart(2, '0')} min/km`);
            document.getElementById('copyButton').style.display = 'block';
            
            updateChart();
        }

        // ==================== GRAFICO ====================
        function updateChart() {
            if (AppState.averagePace === 0) return;
            
            const inclinationPercent = parseFloat(document.getElementById('inclinationSlider').value);
            const totalKm = Math.ceil(AppState.distance);
            const chartType = document.getElementById('chartType').value;
            const chartColor = document.getElementById('chartColor').value;
            const smoothness = parseFloat(document.getElementById('smoothness').value);
            
            AppState.currentPaces = PaceCalculator.calculatePaces(
                inclinationPercent,
                totalKm,
                AppState.averagePace,
                AppState.time
            );
            
            const stats = PaceCalculator.getStats(AppState.currentPaces, AppState.distance, AppState.time);
            UIManager.updateStats(stats, inclinationPercent);
            UIManager.updatePaceList(AppState.currentPaces);
            
            if (AppState.chart) {
                AppState.chart.destroy();
            }
            
            const ctx = document.getElementById('chart').getContext('2d');
            const labels = Array.from({length: totalKm}, (_, i) => `Km ${i + 1}`);
            
            // Configurazione dataset in base al tipo di grafico
            let datasets = [{
                label: 'Passo (min/km)',
                data: AppState.currentPaces,
                borderColor: chartColor,
                backgroundColor: chartType === 'area' ? chartColor + '40' : (chartType === 'bar' ? chartColor : chartColor + '20'),
                borderWidth: chartType === 'bar' ? 0 : 3,
                pointBackgroundColor: chartColor,
                pointRadius: 5,
                pointHoverRadius: 8,
                pointBorderColor: 'white',
                pointBorderWidth: 2,
                tension: smoothness,
                fill: chartType === 'area' || chartType === 'radar',
            }];
            
            AppState.chart = new Chart(ctx, {
                type: chartType === 'area' ? 'line' : chartType,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `Passo: ${PaceCalculator.formatPace(value)} min/km`;
                                },
                                afterLabel: function(context) {
                                    const kmIndex = context.dataIndex;
                                    const totalPaceTime = AppState.currentPaces[kmIndex];
                                    return `Tempo km: ${totalPaceTime.toFixed(2)} min`;
                                }
                            }
                        }
                    },
                    scales: chartType === 'radar' ? {} : {
                        y: {
                            title: { display: true, text: 'Passo (min/km)', font: { weight: 'bold', size: 13 } },
                            ticks: {
                                callback: function(value) {
                                    return PaceCalculator.formatPace(value);
                                }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            title: { display: true, text: 'Distanza (km)', font: { weight: 'bold', size: 13 } },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        }
                    }
                }
            });
            
            updateChartLegend(chartColor);
            
            // Rendere gli elementi della lista draggabili
            setTimeout(() => makePaceItemsDraggable(), 100);
        }

        function updateChartLegend(color) {
            const legend = document.getElementById('chartLegend');
            const min = Math.min(...AppState.currentPaces);
            const max = Math.max(...AppState.currentPaces);
            const avg = AppState.currentPaces.reduce((a, b) => a + b) / AppState.currentPaces.length;
            
            legend.innerHTML = `
                <div class="legend-item">
                    <div class="legend-box" style="background: ${color}66;"></div>
                    <span>Min: ${PaceCalculator.formatPace(min)}</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background: ${color};"></div>
                    <span>Media: ${PaceCalculator.formatPace(avg)}</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background: ${color}cc;"></div>
                    <span>Max: ${PaceCalculator.formatPace(max)}</span>
                </div>
            `;
        }

        // ==================== INTERAZIONI GRAFICO ====================
        const GraphicInteraction = {
            isDragging: false,
            draggedKm: null,
            dragStartY: 0,
            selectedKmInChart: null,
            
            init() {
                const canvas = document.getElementById('chart');
                canvas.addEventListener('mousedown', (e) => this.onCanvasMouseDown(e));
                canvas.addEventListener('mousemove', (e) => this.onCanvasMouseMove(e));
                canvas.addEventListener('mouseup', (e) => this.onCanvasMouseUp(e));
                canvas.addEventListener('mouseleave', (e) => this.onCanvasMouseLeave(e));
                canvas.addEventListener('dblclick', (e) => this.onCanvasDoubleClick(e));
            },
            
            onCanvasMouseDown(e) {
                if (!AppState.chart) return;
                
                const canvasPosition = Chart.helpers.getRelativePosition(e, AppState.chart);
                const dataX = AppState.chart.scales.x.getValueForPixel(canvasPosition.x);
                const dataY = AppState.chart.scales.y.getValueForPixel(canvasPosition.y);
                
                const kmIndex = Math.round(dataX);
                
                if (kmIndex >= 0 && kmIndex < AppState.currentPaces.length) {
                    // Se il pulsante è il sinistro (0)
                    if (e.button === 0) {
                        // Controlla se è doppio click (delegato a onCanvasDoubleClick)
                        this.isDragging = true;
                        this.draggedKm = kmIndex;
                        this.dragStartY = canvasPosition.y;
                        this.originalPace = AppState.currentPaces[kmIndex];
                        
                        this.selectKmInChart(kmIndex);
                        this.showDragIndicator(kmIndex);
                    }
                }
            },
            
            onCanvasMouseMove(e) {
                if (!this.isDragging || this.draggedKm === null) return;
                
                const canvasPosition = Chart.helpers.getRelativePosition(e, AppState.chart);
                const currentDataY = AppState.chart.scales.y.getValueForPixel(canvasPosition.y);
                
                if (currentDataY > 0 && currentDataY < 15) {
                    AppState.currentPaces[this.draggedKm] = currentDataY;
                    this.updateChartData();
                    this.showDragValue(this.draggedKm, currentDataY);
                }
            },
            
            onCanvasMouseUp(e) {
                if (this.isDragging) {
                    this.isDragging = false;
                    this.removeDragIndicator();
                    this.recalculateAndNormalize();
                }
            },
            
            onCanvasMouseLeave(e) {
                if (this.isDragging) {
                    this.isDragging = false;
                    this.removeDragIndicator();
                    this.recalculateAndNormalize();
                }
            },
            
            onCanvasDoubleClick(e) {
                if (!AppState.chart) return;
                
                const canvasPosition = Chart.helpers.getRelativePosition(e, AppState.chart);
                const dataX = AppState.chart.scales.x.getValueForPixel(canvasPosition.x);
                const kmIndex = Math.round(dataX);
                
                if (kmIndex >= 0 && kmIndex < AppState.currentPaces.length) {
                    e.preventDefault();
                    this.isDragging = false;
                    openEditKmModal(kmIndex);
                }
            },
            
            selectKmInChart(kmIndex) {
                this.selectedKmInChart = kmIndex;
                highlightKm(kmIndex);
                
                // Aggiorna lo stile del dataset per evidenziare il punto
                if (AppState.chart) {
                    const pointRadius = new Array(AppState.currentPaces.length).fill(5);
                    pointRadius[kmIndex] = 10;
                    
                    const pointBorderWidth = new Array(AppState.currentPaces.length).fill(2);
                    pointBorderWidth[kmIndex] = 4;
                    
                    AppState.chart.data.datasets[0].pointRadius = pointRadius;
                    AppState.chart.data.datasets[0].pointBorderWidth = pointBorderWidth;
                    AppState.chart.update('none');
                }
            },
            
            updateChartData() {
                if (!AppState.chart) return;
                
                AppState.chart.data.datasets[0].data = [...AppState.currentPaces];
                AppState.chart.update('none');
            },
            
            recalculateAndNormalize() {
                const totalCalculatedTime = AppState.currentPaces.reduce((sum, pace) => sum + pace, 0);
                const normalizationFactor = AppState.time / totalCalculatedTime;
                
                AppState.currentPaces = AppState.currentPaces.map(pace => pace * normalizationFactor);
                this.updateChartData();
                
                UIManager.updatePaceList(AppState.currentPaces);
                this.updateStats();
            },
            
            updateStats() {
                const stats = PaceCalculator.getStats(AppState.currentPaces, AppState.distance, AppState.time);
                UIManager.updateStats(stats, document.getElementById('inclinationSlider').value);
                updateChartLegend(document.getElementById('chartColor').value);
            },
            
            showDragIndicator(kmIndex) {
                const canvas = document.getElementById('chart');
                canvas.style.cursor = 'grab';
                canvas.classList.add('dragging');
            },
            
            removeDragIndicator() {
                const canvas = document.getElementById('chart');
                canvas.style.cursor = 'default';
                canvas.classList.remove('dragging');
            },
            
            showDragValue(kmIndex, pace) {
                const tooltip = document.getElementById('tooltip');
                const formattedPace = PaceCalculator.formatPace(pace);
                tooltip.innerHTML = `<strong>Km ${kmIndex + 1}</strong><br>Passo: ${formattedPace}<br><em>Trascinando... Rilascia o Doppio-click per editare</em>`;
                tooltip.classList.add('active');
            }
        };

        function highlightKm(kmIndex) {
            const paceItems = document.querySelectorAll('#paceList li');
            paceItems.forEach((item, index) => {
                item.style.opacity = (index === kmIndex) ? '1' : '0.5';
                item.style.transform = (index === kmIndex) ? 'scale(1.05)' : 'scale(1)';
                item.style.backgroundColor = (index === kmIndex) ? 'rgba(67, 97, 238, 0.15)' : '';
            });
            
            AppState.selectedKm = kmIndex;
            showKmTooltip(kmIndex);
        }

        function showKmTooltip(kmIndex) {
            const tooltip = document.getElementById('tooltip');
            const pace = AppState.currentPaces[kmIndex];
            const formattedPace = PaceCalculator.formatPace(pace);
            tooltip.innerHTML = `<strong>Km ${kmIndex + 1}</strong><br>Passo: ${formattedPace}`;
            tooltip.classList.add('active');
        }

        // Aggiornamento lista passo con interazioni click e trascinamento
        function makePaceItemsDraggable() {
            const paceItems = document.querySelectorAll('#paceList li');
            paceItems.forEach((item, index) => {
                item.draggable = true;
                
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', index);
                    item.style.opacity = '0.5';
                });
                
                item.addEventListener('dragend', (e) => {
                    item.style.opacity = '1';
                    paceItems.forEach(el => el.style.borderTop = '');
                });
                
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    item.style.borderTop = '3px solid var(--primary-color)';
                });
                
                item.addEventListener('dragleave', (e) => {
                    item.style.borderTop = '';
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIndex = index;
                    
                    if (fromIndex !== toIndex) {
                        swapPaces(fromIndex, toIndex);
                    }
                    item.style.borderTop = '';
                });
            });
        }

        function swapPaces(fromIndex, toIndex) {
            const temp = AppState.currentPaces[fromIndex];
            AppState.currentPaces[fromIndex] = AppState.currentPaces[toIndex];
            AppState.currentPaces[toIndex] = temp;
            
            GraphicInteraction.updateChartData();
            UIManager.updatePaceList(AppState.currentPaces);
        }

        // ==================== EDIT KM MODAL ====================
        function openEditKmModal(kmIndex) {
            const currentPace = AppState.currentPaces[kmIndex];
            const paceMinutes = Math.floor(currentPace);
            const paceSeconds = Math.round((currentPace - paceMinutes) * 60);
            
            const modal = document.getElementById('editKmModal');
            const minutesInput = document.getElementById('editKmMinutes');
            const secondsInput = document.getElementById('editKmSeconds');
            const kmLabel = document.getElementById('editKmLabel');
            const currentPaceDisplay = document.getElementById('currentPaceDisplay');
            
            kmLabel.textContent = `Km ${kmIndex + 1}`;
            minutesInput.value = paceMinutes;
            secondsInput.value = paceSeconds;
            currentPaceDisplay.textContent = PaceCalculator.formatPace(currentPace);
            
            // Salva l'indice nel modal per usarlo quando salvi
            modal.dataset.kmIndex = kmIndex;
            modal.classList.add('active');
            
            // Focus sul campo minuti per comodità
            minutesInput.focus();
            minutesInput.select();
        }

        function closeEditKmModal() {
            document.getElementById('editKmModal').classList.remove('active');
        }

        function saveEditKmModal() {
            const modal = document.getElementById('editKmModal');
            const kmIndex = parseInt(modal.dataset.kmIndex);
            const minutes = parseInt(document.getElementById('editKmMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('editKmSeconds').value) || 0;
            
            if (minutes < 0 || seconds < 0 || seconds >= 60) {
                alert('❌ Inserisci valori validi (minuti >= 0, secondi 0-59)');
                return;
            }
            
            const newPace = minutes + (seconds / 60);
            
            if (newPace <= 0) {
                alert('❌ Il passo deve essere positivo');
                return;
            }
            
            AppState.currentPaces[kmIndex] = newPace;
            
            // Normalizza per mantenere il tempo totale
            const totalCalculatedTime = AppState.currentPaces.reduce((sum, pace) => sum + pace, 0);
            const normalizationFactor = AppState.time / totalCalculatedTime;
            AppState.currentPaces = AppState.currentPaces.map(pace => pace * normalizationFactor);
            
            GraphicInteraction.updateChartData();
            UIManager.updatePaceList(AppState.currentPaces);
            GraphicInteraction.updateStats();
            
            closeEditKmModal();
        }

        // Enter key per salvare nel modal
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('editKmModal');
            if (modal && modal.classList.contains('active') && e.key === 'Enter') {
                saveEditKmModal();
            }
        });

        // ==================== INCLINAZIONE ====================
        function updateInclination() {
            const inclinationPercent = document.getElementById('inclinationSlider').value;
            document.getElementById('inclinationInput').value = inclinationPercent;
            document.getElementById('inclinationValue').textContent = `${inclinationPercent}%`;
            updateChart();
        }

        function updateInclinationFromInput() {
            const inclinationPercent = document.getElementById('inclinationInput').value;
            document.getElementById('inclinationSlider').value = inclinationPercent;
            document.getElementById('inclinationValue').textContent = `${inclinationPercent}%`;
            updateChart();
        }

        function adjustInclination(delta) {
            const input = document.getElementById('inclinationInput');
            input.value = Math.max(-10, Math.min(10, parseFloat(input.value) + delta));
            updateInclinationFromInput();
        }

        // ==================== EXPORT ====================
        function openCopyDialog() {
            const modal = document.getElementById('copyModal');
            const copyText = document.getElementById('copyText');
            
            const workoutName = document.getElementById('workoutName').value || "Allenamento senza nome";
            const workoutDateTime = document.getElementById('workoutDateTime').value;
            const distance = document.getElementById('distance').value;
            const time = document.getElementById('time').value;
            const inclination = document.getElementById('inclinationSlider').value;
            const result = document.getElementById('result').textContent;
            const paceList = document.getElementById('paceList').innerText;
            
            const formattedDateTime = new Date(workoutDateTime).toLocaleString('it-IT', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const textToCopy = `╔════════════════════════════════════════╗
║  CALCOLATORE DI PASSO AVANZATO v2.0  ║
╚════════════════════════════════════════╝

🏃 ${workoutName}
📅 ${formattedDateTime}

📊 PARAMETRI ALLENAMENTO
${'-'.repeat(40)}
Distanza: ${distance} km
Tempo totale: ${time} min
Inclinazione: ${inclination}%

📈 RISULTATI
${'-'.repeat(40)}
${result}

${paceList}

${'-'.repeat(40)}
Generato da: Calcolatore di Passo v2.0`;
            
            copyText.value = textToCopy;
            modal.classList.add('active');
        }

        function closeCopyDialog() {
            document.getElementById('copyModal').classList.remove('active');
        }

        async function copyToClipboard() {
            const copyText = document.getElementById('copyText');
            
            try {
                await navigator.clipboard.writeText(copyText.value);
                alert('✅ Dati copiati negli appunti!');
            } catch (err) {
                copyText.select();
                document.execCommand('copy');
                alert('✅ Dati copiati negli appunti!');
            }
        }

        function exportAsImage() {
            const canvas = document.getElementById('chart');
            const image = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = image;
            link.download = `passo-grafico-${new Date().getTime()}.png`;
            link.click();
        }

        // ==================== RESET ====================
        function resetForm() {
            document.getElementById('distance').value = 10;
            document.getElementById('time').value = 60;
            document.getElementById('inclinationSlider').value = 0;
            document.getElementById('inclinationInput').value = 0;
            document.getElementById('inclinationValue').textContent = '0%';
            document.getElementById('result').style.display = 'none';
            document.getElementById('copyButton').style.display = 'none';
            document.getElementById('paceList').classList.remove('active');
            document.getElementById('statsBox').classList.add('hidden');
            
            AppState.averagePace = 0;
            AppState.currentPaces = [];
            
            if (AppState.chart) {
                AppState.chart.destroy();
                AppState.chart = null;
            }
        }

        // ==================== EVENTS ====================
        document.getElementById('copyModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeCopyDialog();
            }
        });

        document.addEventListener('click', function(e) {
            const tooltip = document.getElementById('tooltip');
            if (!e.target.closest('#paceList')) {
                tooltip.classList.remove('active');
            }
        });

        // ==================== INIT ====================
        AppState.init();
        
        // Inizializzare le interazioni del grafico dopo il caricamento
        document.addEventListener('DOMContentLoaded', () => {
            GraphicInteraction.init();
        });
    </script>
</body>
</html>
